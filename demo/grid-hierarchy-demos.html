<dom-module id="grid-hierarchy-demos">
  <template>
    <style>
       :host {
        display: block;
      }

    </style>


    <h3>Assigning Hierarchical Data Using Data Provider</h3>
    <vaadin-demo-snippet id="grid-hierarchy-demos-data-provider">
      <template preserve-content>
        <x-hierarchical-data-provider-example></x-hierarchical-data-provider-example>
        <dom-module id="x-hierarchical-data-provider-example">
          <template preserve-content>
            <vaadin-grid aria-label="Hierarchical Data Grid Example" data-provider="[[_dataProvider]]">

              <vaadin-grid-column>
                <template class="header">Package name</template>
                <template>
                  <vaadin-grid-hierarchy-toggle
                      enabled="[[item.hasChildren]]"
                      expanded="{{expanded}}"
                      level="[[level]]">
                    [[item.name]]
                  </vaadin-grid-hierarchy-toggle>
                </template>
              </vaadin-grid-column>

              <vaadin-grid-column>
                <template class="header">Version specified</template>
                <template>[[item.version]]</template>
              </vaadin-grid-column>

            </vaadin-grid>
          </template>
          <script>
            window.addDemoReadyListener('#grid-hierarchy-demos-data-provider', function(document) {
              Polymer({
                is: 'x-hierarchical-data-provider-example',

                properties: {
                  _dataProvider: {
                    type: Function,
                    value: function() {
                      return this._dataProvider.bind(this);
                    }
                  }
                },

                _dataProvider: function(params, callback) {
                  const pkgName = params.parentItem ?
                    params.parentItem.name :
                    'vaadin-grid';

                  // Helper API that fetches dependencies for a package
                  this._fetchDependencies(pkgName, function(dependencies) {
                    callback(
                      dependencies.slice(
                        params.page * params.pageSize,
                        (params.page + 1) * params.pageSize
                      ),
                      dependencies.length
                    );
                  });
                }
              });
            });
          </script>
        </dom-module>
      </template>
    </vaadin-demo-snippet>

  </template>
  <script>
    class GridHierarchyDemos extends DemoReadyEventEmitter(GridDemo(Polymer.Element)) {
      static get is() {
        return 'grid-hierarchy-demos';
      }

      ready() {
        super.ready();

        const snippet = this.shadowRoot.querySelector('#grid-hierarchy-demos-data-provider');
        const dataProviderDemo = snippet.shadowRoot.querySelector('x-hierarchical-data-provider-example');

        dataProviderDemo._fetchDependencies = (packageName, callback) => {
          const requests = new Set;
          dataProviderDemo._fetchFlatDependencies(packageName, deps => {
            deps.forEach(dep => {
              requests.add(dep);
              dataProviderDemo._fetchFlatDependencies(dep.name, subDeps => {
                dep.hasChildren = subDeps.length > 0;
                requests.delete(dep);
                if (requests.size === 0) {
                  callback(deps);
                }
              });
            });
          });
        };

        dataProviderDemo._fetchFlatDependencies = (packageName, callback) => {
          const xhr = new XMLHttpRequest();
          xhr.open('GET', `${this.importPath}../../${packageName}/bower.json`);
          xhr.onload = function() {
            const json = JSON.parse(this.responseText);
            const deps = Object.keys(json.dependencies || []).map(dep => {
              return {
                name: dep,
                version: json.dependencies[dep].split('#').pop()
              };
            });
            callback(deps);
          };
          xhr.send();
        };
      }
    }
    customElements.define(GridHierarchyDemos.is, GridHierarchyDemos);
  </script>
</dom-module>
